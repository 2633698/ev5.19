<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV充电调度仿真系统</title>
    <!-- jQuery (必须在Bootstrap之前引入) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- Main Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-charging-station me-2"></i>EV充电调度仿真系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="展开导航菜单" title="展开导航菜单">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">宏观调控视角</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/user">用户面板</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/operator">运营商面板</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/grid">电网面板</a>
                    </li>
                </ul>
                <div class="ms-auto d-flex align-items-center text-light">
                    <div id="system-time" class="me-3">
                        <i class="far fa-clock me-1"></i>
                        <span id="current-system-time">2023-01-01 00:00</span>
                    </div>
                    <div class="btn-group me-3">
                        <button class="btn btn-sm btn-outline-light" id="sim-speed-1x" title="速度1倍">1x</button>
                        <button class="btn btn-sm btn-outline-light" id="sim-speed-2x" title="速度2倍">2x</button>
                        <button class="btn btn-sm btn-outline-light" id="sim-speed-5x" title="速度5倍">5x</button>
                        <button class="btn btn-sm btn-outline-light" id="sim-speed-max" title="最大速度">Max</button>
                    </div>
                    <button class="btn btn-sm btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#configModal" title="系统配置">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#helpModal" title="帮助信息">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Global Control Panel -->
    <div class="container-fluid mt-5 pt-3">
        <div class="row control-panel bg-light p-3 rounded shadow-sm mb-4">
            <div class="col-md-3">
                <div class="d-flex">
                    <button id="btn-start-simulation" class="btn btn-success me-2" title="开始模拟">
                        <i class="fas fa-play"></i> 开始
                    </button>
                    <button id="btn-pause-simulation" class="btn btn-warning me-2" disabled title="暂停模拟">
                        <i class="fas fa-pause"></i> 暂停
                    </button>
                    <button id="btn-reset-simulation" class="btn btn-danger" title="重置模拟">
                        <i class="fas fa-stop"></i> 重置
                    </button>
                    <button id="btn-load-result" class="btn btn-info" title="加载结果">
                        <i class="fas fa-folder-open"></i> 加载结果
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label for="simulation-days" class="form-label">模拟天数</label>
                <input type="range" class="form-range" id="simulation-days" min="1" max="30" value="7" aria-label="模拟天数滑块">
                <div class="d-flex justify-content-between">
                    <small>1天</small>
                    <small id="days-value">7天</small>
                    <small>30天</small>
                </div>
            </div>
            <div class="col-md-3">
                <label for="strategy-select" class="form-label">策略选择 (用于非MARL)</label>
                <select id="strategy-select" class="form-select" aria-label="选择优化策略 (用于非MARL)">
                    <option value="balanced" selected>平衡模式</option>
                    <option value="user">用户优先</option>
                    <option value="grid">电网优先</option>
                    <option value="profit">利润优先</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="algorithm-select" class="form-label">调度算法</label>
                <select id="algorithm-select" class="form-select" aria-label="选择调度算法">
                    <option value="rule_based" selected>规则</option>
                    <option value="coordinated_mas">协调MAS</option>
                    <option value="marl">MARL</option>
                    <option value="uncoordinated">无序充电(基准)</option>
                </select>
            </div>
            <div class="col-md-1">
                <div class="form-check form-switch mt-4">
                    <input class="form-check-input" type="checkbox" id="multi-agent-switch" aria-label="启用多智能体系统" disabled>
                    <label class="form-check-label" for="multi-agent-switch" title="由算法选择决定">MAS</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title text-muted">当前模拟时间</h6>
                        <h4 id="simulation-time">2023-01-01 00:00</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title text-muted">模拟进度</h6>
                        <div class="progress">
                            <div id="simulation-progress" class="progress-bar" role="progressbar" style="width: 0%" aria-label="模拟进度" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title text-muted">实时指标</h6>
                        <div class="row">
                            <div class="col">
                                <span class="badge bg-primary p-2">
                                    <i class="fas fa-user me-1"></i> 用户满意度: <span id="metric-user">0.00</span>
                                </span>
                            </div>
                            <div class="col">
                                <span class="badge bg-success p-2">
                                    <i class="fas fa-dollar-sign me-1"></i> 运营商利润: <span id="metric-profit">0.00</span>
                                </span>
                            </div>
                            <div class="col">
                                <span class="badge bg-info p-2">
                                    <i class="fas fa-bolt me-1"></i> 电网友好度: <span id="metric-grid">0.00</span>
                                </span>
                            </div>
                            <div class="col">
                                <span class="badge bg-secondary p-2">
                                    <i class="fas fa-star me-1"></i> 综合评分: <span id="metric-total">0.00</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="container-fluid">
        <div class="row">
            <!-- System Overview -->
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">系统概览</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">用户满意度</h6>
                                        <h3 id="overview-user-satisfaction" class="text-primary">0.00</h3>
                                        <small id="user-trend" class="text-success">
                                            <i class="fas fa-arrow-up"></i> 0.00%
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">运营商利润</h6>
                                        <h3 id="overview-operator-profit" class="text-success">0.00</h3>
                                        <small id="profit-trend" class="text-success">
                                            <i class="fas fa-arrow-up"></i> 0.00%
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">电网友好度</h6>
                                        <h3 id="overview-grid-friendliness" class="text-info">0.00</h3>
                                        <small id="grid-trend" class="text-success">
                                            <i class="fas fa-arrow-up"></i> 0.00%
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">综合评分</h6>
                                        <h3 id="overview-total-score" class="text-secondary">0.00</h3>
                                        <small id="total-trend" class="text-success">
                                            <i class="fas fa-arrow-up"></i> 0.00%
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Multi-Agent Monitoring -->
                <div class="card shadow-sm mb-4" id="multi-agent-card" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">多智能体监控</h5>
                    </div>
                    <div class="card-body">
                        <div id="agent-weights-chart-container">
                            <canvas id="agent-weights-chart"></canvas>
                        </div>
                        <div class="mt-3">
                            <h6>智能体权重调整</h6>
                            <div class="mb-2">
                                <label class="form-label" for="user-satisfaction-weight">用户满意度智能体 <span class="user-weight-display">0.40</span></label>
                                <input type="range" class="form-range" id="user-satisfaction-weight" min="0.1" max="0.8" step="0.05" value="0.4" aria-label="用户满意度智能体权重">
                            </div>
                            <div class="mb-2">
                                <label class="form-label" for="operator-profit-weight">运营商利润智能体 <span class="profit-weight-display">0.30</span></label>
                                <input type="range" class="form-range" id="operator-profit-weight" min="0.1" max="0.8" step="0.05" value="0.3" aria-label="运营商利润智能体权重">
                            </div>
                            <div class="mb-2">
                                <label class="form-label" for="grid-friendliness-weight">电网友好度智能体 <span class="grid-weight-display">0.30</span></label>
                                <input type="range" class="form-range" id="grid-friendliness-weight" min="0.1" max="0.8" step="0.05" value="0.3" aria-label="电网友好度智能体权重">
                            </div>
                            <button class="btn btn-primary btn-sm mt-2" id="apply-weights" title="应用智能体权重设置">应用权重设置</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Data Analysis -->
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">实时数据分析</h5>
                    </div>
                    <div class="card-body">
                        <!-- 替换标签页为四宫格布局 -->
                        <div class="row">
                            <!-- 时间序列图 -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header py-2 bg-primary text-white">
                                        <h6 class="mb-0">时间序列图</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center p-3">
                                        <div style="width: 100%; height: 100%; min-height: 200px;">
                                            <canvas id="metrics-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 充电桩负载热力图 -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header py-2 bg-success text-white">
                                        <h6 class="mb-0">充电桩负载热力图</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center p-3">
                                        <div id="charger-heatmap-container" style="width: 100%; height: 100%; min-height: 200px;">
                                            <canvas id="charger-heatmap"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 用户等待时间 -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header py-2 bg-warning text-dark">
                                        <h6 class="mb-0">用户等待时间</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center p-3">
                                        <div style="width: 100%; height: 100%; min-height: 200px;">
                                            <canvas id="user-wait-time-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 电网负载 -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header py-2 bg-info text-white">
                                        <h6 class="mb-0">电网负载</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center p-3">
                                        <div style="width: 100%; height: 100%; min-height: 200px;">
                                            <canvas id="grid-load-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Management -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">配置管理</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>环境参数</h6>
                                <div class="input-group mb-2">
                                    <span class="input-group-text" id="charger-count-label">充电桩数量</span>
                                    <input type="number" class="form-control" id="charger-count" min="1" max="100" value="20" aria-labelledby="charger-count-label">
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text" id="user-count-label">用户数量</span>
                                    <input type="number" class="form-control" id="user-count" min="1" max="200" value="50" aria-labelledby="user-count-label">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>场景预设</h6>
                                <select id="scenario-select" class="form-select mb-2" aria-label="场景预设选择">
                                    <option value="normal">正常工作日</option>
                                    <option value="peak">假日高峰</option>
                                    <option value="night">低负载夜间</option>
                                    <option value="failure">充电桩故障</option>
                                </select>
                                <button id="apply-scenario" class="btn btn-primary btn-sm" title="应用选中的场景">应用场景</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 电网负载监控 - 只保留实时负载指标 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">实时负载指标</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="metric-item text-center mb-3">
                                    <label>总负载</label>
                                    <h3 id="totalLoad">0 kW</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-item text-center mb-3">
                                    <label>EV充电负载</label>
                                    <h3 id="evLoad">0 kW</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-item text-center mb-3">
                                    <label>可再生能源比例</label>
                                    <h3 id="renewableRatio">0%</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map View (Second row) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">地图视图</h5>
                    </div>
                    <div class="card-body">
                        <div id="map-container" style="height: 700px;">
                            <!-- The map will be rendered here -->
                            <div class="text-center py-5 bg-light">
                                <h5>地图视图将在将在模拟开始后显示</h5>
                                <p class="text-muted">显示充电桩分布和用户位置</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Decisions (only visible when multi-agent is enabled) -->
        <div class="row mb-4" id="agent-decision-panel" style="display: none;">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">多智能体决策分析</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="agent-rewards-chart" height="250"></canvas>
                            </div>
                            <div class="col-md-6">
                                <canvas id="coordination-conflicts-chart" height="250"></canvas>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h6>智能体决策一致性分析</h6>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>智能体</th>
                                        <th>决策次数</th>
                                        <th>被采纳率</th>
                                        <th>平均奖励</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>用户满意度智能体</td>
                                        <td id="user-agent-decisions">0</td>
                                        <td id="user-agent-adoption">0%</td>
                                        <td id="user-agent-reward">0.00</td>
                                    </tr>
                                    <tr>
                                        <td>运营商利润智能体</td>
                                        <td id="profit-agent-decisions">0</td>
                                        <td id="profit-agent-adoption">0%</td>
                                        <td id="profit-agent-reward">0.00</td>
                                    </tr>
                                    <tr>
                                        <td>电网友好度智能体</td>
                                        <td id="grid-agent-decisions">0</td>
                                        <td id="grid-agent-adoption">0%</td>
                                        <td id="grid-agent-reward">0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charging Stations -->
        <div class="dashboard-section">
            <h3>充电站状态</h3>
            <div id="charging-stations" class="charging-stations-container">
                <!-- 充电站状态将通过JavaScript动态填充 -->
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel">系统配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="configTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="env-tab" data-bs-toggle="tab" data-bs-target="#env" type="button" role="tab" aria-controls="env" aria-selected="true">环境设置</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="scheduler-tab" data-bs-toggle="tab" data-bs-target="#scheduler" type="button" role="tab" aria-controls="scheduler" aria-selected="false">调度器设置</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="model-tab" data-bs-toggle="tab" data-bs-target="#model" type="button" role="tab" aria-controls="model" aria-selected="false">模型设置</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="configTabContent">
                        <div class="tab-pane fade show active" id="env" role="tabpanel">
                            <div class="mb-3">
                                <label for="config-grid-id" class="form-label">电网ID</label>
                                <input type="text" class="form-control" id="config-grid-id">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="config-station-count" class="form-label">充电站数量</label>
                                        <input type="number" class="form-control" id="config-station-count" min="1" max="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="config-chargers-per-station" class="form-label">每站充电桩数量</label>
                                        <input type="number" class="form-control" id="config-chargers-per-station" min="1" max="50">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="config-user-count" class="form-label">用户数量</label>
                                        <input type="number" class="form-control" id="config-user-count" min="1" max="2000">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="config-region-count" class="form-label">区域数量</label>
                                        <input type="number" class="form-control" id="config-region-count" min="1" max="10">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="config-simulation-days" class="form-label">模拟天数</label>
                                        <input type="number" class="form-control" id="config-simulation-days" min="1" max="30">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="config-time-step" class="form-label">时间步长(分钟)</label>
                                        <input type="number" class="form-control" id="config-time-step" min="5" max="60" step="5">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">地图边界设置</label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <input type="number" class="form-control mb-2" id="config-min-lat" placeholder="最小纬度">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control mb-2" id="config-max-lat" placeholder="最大纬度">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control mb-2" id="config-min-lng" placeholder="最小经度">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control mb-2" id="config-max-lng" placeholder="最大经度">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="scheduler" role="tabpanel">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="config-use-model">
                                <label class="form-check-label" for="config-use-model">使用训练模型</label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="config-use-multi-agent">
                                <label class="form-check-label" for="config-use-multi-agent">使用多智能体系统</label>
                            </div>
                            <h6>优化权重</h6>
                            <div class="mb-3">
                                <label for="config-user-weight" class="form-label">用户满意度权重</label>
                                <input type="range" class="form-range" id="config-user-weight" min="0.1" max="0.8" step="0.05">
                                <span id="config-user-weight-value">0.4</span>
                            </div>
                            <div class="mb-3">
                                <label for="config-profit-weight" class="form-label">运营商利润权重</label>
                                <input type="range" class="form-range" id="config-profit-weight" min="0.1" max="0.8" step="0.05">
                                <span id="config-profit-weight-value">0.3</span>
                            </div>
                            <div class="mb-3">
                                <label for="config-grid-weight" class="form-label">电网友好度权重</label>
                                <input type="range" class="form-range" id="config-grid-weight" min="0.1" max="0.8" step="0.05">
                                <span id="config-grid-weight-value">0.3</span>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="model" role="tabpanel">
                            <div class="mb-3">
                                <label for="config-model-path" class="form-label">模型路径</label>
                                <input type="text" class="form-control" id="config-model-path">
                            </div>
                            <div class="mb-3">
                                <label for="config-input-dim" class="form-label">输入维度</label>
                                <input type="number" class="form-control" id="config-input-dim">
                            </div>
                            <div class="mb-3">
                                <label for="config-hidden-dim" class="form-label">隐藏层维度</label>
                                <input type="number" class="form-control" id="config-hidden-dim">
                            </div>
                            <div class="mb-3">
                                <label for="config-task-hidden-dim" class="form-label">任务隐藏层维度</label>
                                <input type="number" class="form-control" id="config-task-hidden-dim">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-config">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">帮助</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <h6>系统介绍</h6>
                    <p>电动车充电调度仿真系统是一个用于模拟电动汽车充电调度的工具，支持多种优化策略，可以分析用户满意度、运营商利润和电网友好度三个关键指标的变化。</p>
                    
                    <h6>主要功能</h6>
                    <ul>
                        <li><strong>充电策略模拟</strong>：支持平衡模式、用户优先、电网优先和利润优先四种策略</li>
                        <li><strong>结果分析与可视化</strong>：自动生成指标图表、用户分析和电网影响分析</li>
                        <li><strong>配置管理</strong>：支持自定义充电桩数量、用户数量、模拟天数等参数</li>
                        <li><strong>多智能体系统</strong>：采用多智能体架构实现三方面需求的平衡调节</li>
                    </ul>
                    
                    <h6>使用说明</h6>
                    <ol>
                        <li>设置模拟参数，选择策略</li>
                        <li>选择是否启用多智能体系统</li>
                        <li>点击"开始模拟"按钮</li>
                        <li>查看模拟结果和分析</li>
                    </ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" title="关闭帮助窗口">明白了</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Tippy.js for tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
    
    <!-- Custom JavaScript -->
    <script src="/static/js/main.js"></script>
    
    <!-- 内联脚本确保按钮响应 -->
    <script>
        // 页面加载完成后直接绑定按钮事件
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM完全加载 - 直接绑定按钮事件");
            
            // 开始按钮
            document.getElementById('btn-start-simulation').addEventListener('click', function(e) {
                console.log("开始按钮被点击 (内联脚本)");
                // 阻止可能的默认行为
                e.preventDefault();
                
                // 手动调用startSimulation函数 
                if (typeof startSimulation === 'function') {
                    startSimulation();
                } else {
                    console.error("startSimulation函数未定义");
                    alert("应用程序出错: 启动函数未加载");
                }
            });
            
            // 暂停按钮
            document.getElementById('btn-pause-simulation').addEventListener('click', function(e) {
                console.log("暂停按钮被点击 (内联脚本)");
                e.preventDefault();
                if (typeof pauseSimulation === 'function') {
                    pauseSimulation();
                }
            });
            
            // 重置按钮
            document.getElementById('btn-reset-simulation').addEventListener('click', function(e) {
                console.log("重置按钮被点击 (内联脚本)");
                e.preventDefault();
                if (typeof resetSimulation === 'function') {
                    resetSimulation();
                }
            });
            
            // 配置保存按钮
            document.getElementById('save-config').addEventListener('click', function(e) {
                console.log("保存配置按钮被点击 (内联脚本)");
                e.preventDefault();
                if (typeof saveConfig === 'function') {
                    saveConfig();
                }
            });
            
            console.log("内联脚本绑定完成");
        });
    </script>

    <script>
    function updateChargingStations(stations) {
        const container = document.getElementById('charging-stations');
        container.innerHTML = '';
        
        stations.forEach(station => {
            const stationElement = document.createElement('div');
            stationElement.className = 'charging-station';
            
            const utilizationClass = station.utilization_rate > 80 ? 'high-utilization' : 
                                   station.utilization_rate > 50 ? 'medium-utilization' : 'low-utilization';
            
            stationElement.innerHTML = `
                <div class="station-header">
                    <h4>${station.location} (${station.id})</h4>
                    <span class="utilization ${utilizationClass}">${station.utilization_rate}%</span>
                </div>
                <div class="station-details">
                    <p>总充电位: ${station.total_slots}</p>
                    <p>已占用: ${station.occupied_slots}</p>
                    <div class="power-levels">
                        <p>充电功率等级:</p>
                        <ul>
                            ${station.power_levels.map((power, index) => 
                                `<li>${power}kW: ${station.power_slots[index]}个</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            container.appendChild(stationElement);
        });
    }

    function updateDashboard() {
        fetch('/api/system_state')
            .then(response => response.json())
            .then(data => {
                updateProgress(data.progress);
                updateMetrics(data.metrics);
                updateChargingStations(data.charging_stations);
            })
            .catch(error => console.error('Error fetching system state:', error));
    }
    </script>

    <style>
    .charging-stations-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .charging-station {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #fff;
    }

    .station-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .utilization {
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
    }

    .high-utilization {
        background-color: #ff6b6b;
        color: white;
    }

    .medium-utilization {
        background-color: #ffd93d;
        color: black;
    }

    .low-utilization {
        background-color: #6bff6b;
        color: black;
    }

    .power-levels ul {
        list-style-type: none;
        padding-left: 0;
    }

    .power-levels li {
        margin: 5px 0;
    }
    </style>
</body>
</html>